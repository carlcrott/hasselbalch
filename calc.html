<html>
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script>
        $(document).ready(function() {


            //// Buffer System Attributes:
            // Change these to update the values which are placed in the input boxes
            // Values must match exact names in the #buffer_system dropdown

            var bufferSystemAttributes = {
                "Sodium phosphate":     [6.82,   "NaH2PO4",       119.98,  "g/mol",   "Na2HPO4",      141.96,     "g/mol"],
                "Tris":                 [8.214,  "Tris-HCl",      157.59,  "g/mol",   "Tris-OH",      121.136,    "g/mol"],
                "Ammonium acetate 1":   [9.25,   "Acetic acid",   60.05,   "g/mol",   "NH4-acetate",  77.0825,    "g/mol"],
                "Ammonium acetate 2":   [4.74,   "Acetic acid",   60.05,   "g/mol",   "NH4-acetate",  77.0825,    "g/mol"],
            }

            function log10(val) {
              return Math.log(val) / Math.LN10;
            }

            function hendersonHasselbalch() {
                calc_coeff = parseFloat( $("#hh_coeff").val() );
                calc_exp = parseFloat( $("#hh_exp").val() );
                calc_base = parseFloat( $("#hh_base_mw").val() );
                calc_acid = parseFloat( $("#hh_acid_mw").val() );

                // Get pKa from bufferSystemAttributes using the name of the buffer system
                bufferSystemName = $("select#buffer_system").val()
                pKa = bufferSystemAttributes[bufferSystemName][0];
                console.log("pKa: " + pKa );

                // pH = pKa + log_10( base / acid )
                // pH = pKa + log_10( 0.025 / 0.0025 )
                // Math.log(Math.pow(10, -7)*4.2)/Math.log(10)
                // -Math.log(Math.pow(10, -7)*4.2)/Math.log(10) + ( Math.log(0.025/0.0025) /Math.log(10) )

                desired_final_ph = parseFloat ( $("#hh_final_ph").val() )
                desired_final_conc = parseFloat ( $("#hh_final_conc").val() )
                desired_final_vol = parseFloat ( $("#hh_final_vol").val() )

                // base / acid ratio = 10^(desired_final_ph - pKa)
                ratio_base_to_acid = Math.pow(10, desired_final_ph - pKa)
                console.log("ratio_base_to_acid: " + ratio_base_to_acid );

                // intermediates
                intermediate_molar_acid = desired_final_conc / ( 1 +  ratio_base_to_acid )
                console.log("intermediate_molar_acid: " + intermediate_molar_acid );
                intermediate_molar_base = desired_final_conc - intermediate_molar_acid
                console.log("intermediate_molar_base: " + intermediate_molar_base );

                // final
                final_acid_mass = intermediate_molar_acid * calc_acid * desired_final_vol
                console.log("final_acid_mass: " + final_acid_mass );
                final_base_mass = intermediate_molar_base * calc_base * desired_final_vol
                console.log("final_base_mass: " + final_base_mass );

                // Write out required mass for
                $("#hh_req_acid_mass").val( final_acid_mass.toFixed(2) );
                $("#hh_req_base_mass").val( final_base_mass.toFixed(2) );

                // TODO: write a few test cases

            }

            $("#hh_run").on('click', hendersonHasselbalch );

            function toggleDisabled() {
                alert("Not Yet Implemented!");
//                return this.each(function () {
//                    var $this = $(this);
//                    if ($this.prop('disabled')) {
//                        $this.prop('disabled', false).show();
//                    } else {
//                        $this.prop('disabled', true).hide();
//                    }
//                });
            }

            $("#custom_toggle").on('click', toggleDisabled );

            function updateBufferSystemAttributes () {
                bufferSystemName = $("select#buffer_system").val()
                console.log(bufferSystemName);
                
                $("#hh_acid").val(bufferSystemAttributes[bufferSystemName][1]);
                $("#hh_acid_mw").val(bufferSystemAttributes[bufferSystemName][2]);
                $("#hh_acid_mw_units").val(bufferSystemAttributes[bufferSystemName][3]);

                $("#hh_base").val(bufferSystemAttributes[bufferSystemName][4]);
                $("#hh_base_mw").val(bufferSystemAttributes[bufferSystemName][5]);
                $("#hh_base_mw_units").val(bufferSystemAttributes[bufferSystemName][6]);

            }

            // On changing the buffer system update the buffer attributes
            $("#buffer_system").on('change', updateBufferSystemAttributes);
            

            
        });
    </script>

    <style type="text/css">
        input[type="text"]{
            width:80px;
        }
        .tg  {border-collapse:collapse;border-spacing:0;}
        .tg td, th {
            font-family:Arial, sans-serif;font-size:14px;font-weight:normal;
            padding:10px 5px;
            text-align: center;
            border: 1px solid lightgrey;
            overflow:hidden;word-break:normal;}
    </style>

<head>


<body>

<input type="checkbox" name="custom" value="custom" id="custom_toggle"> Enter custom values

<table class="tg">
  <tr id="buffer_system">
    <th class="tg-031e">

    buffer system: <br />
    <select id="buffer_system">
        <option>Sodium phosphate</option>
        <option>Tris</option>
        <option>Ammonium acetate 1</option>
        <option>Ammonium acetate 2</option>
    </select>
    <br />

    </th>
    <th class="tg-031e">
        acid:<br />
        <input type="text" id="hh_acid" value="NaH2PO4" disabled="disabled"><br />
    </th>
    <th class="tg-031e">
        acid Mw:<br />
        <input type="text" id="hh_acid_mw" value="119.98" disabled="disabled"> <input type="text" id="hh_acid_mw_units" value="g/mol" disabled="disabled"><br />
    </th>
    <th class="tg-031e">
        base:<br />
        <input type="text" id="hh_base" value="NA2HPO4" disabled="disabled"><br />
    </th>
    <th class="tg-031e">
        base Mw:<br />
        <input type="text" id="hh_base_mw" value="141.96" disabled="disabled"> <input type="text" id="hh_base_mw_units" value="g/mol" disabled="disabled"> <br />
    </th>
  </tr>

  <tr>
    <td class="tg-031e">Enter your requirements:</td>
    <td class="tg-031e">
        pH: <br />
        <input type="text" id="hh_final_ph">
    </td>
    <td class="tg-031e">
        Concentration: <br />
        <input type="text" id="hh_final_conc"> M
    </td>
    <td class="tg-031e">
        Volume: <br />
        <input type="text" id="hh_final_vol"> L

    </td>
    <td class="tg-031e"></td>
  </tr>

</table>

<p> &nbsp; </p>
<button id="hh_run">calculate</button><br />
<p> &nbsp; </p>

Results:
<table class="tg" id="results">
  <tr>
    <td class="tg-031e"> You need</td>
    <td class="tg-031e">
        Acid mass:<br/>
        <input type="text" id="hh_req_acid_mass"> g
    </td>
    <td class="tg-031e">
        Base mass:<br/>
        <input type="text" id="hh_req_base_mass"> g
    </td>
    <td class="tg-031e"></td>
    <td class="tg-031e"></td>
  </tr>

</table>

</body>

</html>
