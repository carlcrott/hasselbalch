<html>
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script>

        // change this to enable running test suite
        var DEBUG=true;

        //// Buffer System Attributes:
        // Change these to update the values which are placed in the input boxes
        // Values must match exact names in the buffer_system dropdown 

        var bufferSystemAttributes = {
            "Sodium phosphate":     [6.82,   "NaH2PO4",       119.98,  "g/mol",   "Na2HPO4",      141.96,     "g/mol"],
            "Tris":                 [8.214,  "Tris-HCl",      157.59,  "g/mol",   "Tris-OH",      121.136,    "g/mol"],
            "Ammonium acetate 1":   [9.25,   "Acetic acid",   60.05,   "g/mol",   "NH4-acetate",  77.0825,    "g/mol"],
            "Ammonium acetate 2":   [4.74,   "Acetic acid",   60.05,   "g/mol",   "NH4-acetate",  77.0825,    "g/mol"],
        }


        /////////////////////
        //  Establish functions
        /////////////////////

        function runTestSuite(){
            //                          buffer name          base Mw,   acid Mw,    pH,     conc,   vol,    acid out,   base out 
            testTrisInputs            = ['Tris',             121.136,   157.591,    7,      1,      0.5,    '74.26',    '3.49'];
            testSodiumPhosphateInputs = ['Sodium phosphate', 141.96,    119.98,     7.4,    1,      0.5,    '12.49',    '56.20'];
            testSystems = [testTrisInputs, testSodiumPhosphateInputs];

            for (i = 0; i < testSystems.length; i++) {
                // select system
                $("#buffer_system").val( testSystems[i][0] );
                // input test values
                $("#hh_base_mw").val( testSystems[i][1] );
                $("#hh_acid_mw").val( testSystems[i][2] );
                $("#hh_final_ph").val( testSystems[i][3] );
                $("#hh_final_conc").val( testSystems[i][4] );
                $("#hh_final_vol").val( testSystems[i][5] );
                // fire off calculation
                $('#hh_run').trigger('click');
                // verify outputs
                if ( ( $('#hh_req_acid_mass').val() == testSystems[i][6] ) && ( $('#hh_req_base_mass').val() == testSystems[i][7] ) ){
                    console.log( "------------ " + testSystems[i][0] + " PASSED!" );
                } else {
                    console.log( "------------ " + testSystems[i][0] + " FAILED!" );
                }

            }

            // clear out test residual
            $("#hh_base_mw").val("");
            $("#hh_acid_mw").val("");
            $("#hh_final_ph").val("");
            $("#hh_final_conc").val("");
            $("#hh_final_vol").val("");
            $('#hh_req_acid_mass').val("")
            $('#hh_req_base_mass').val("")

        }

        function log10(val) {
          return Math.log(val) / Math.LN10;
        }

        function hendersonHasselbalch() {
            calc_base = parseFloat( $("#hh_base_mw").val() );
            calc_acid = parseFloat( $("#hh_acid_mw").val() );
            desired_final_ph = parseFloat( $("#hh_final_ph").val() )
            desired_final_conc = parseFloat( $("#hh_final_conc").val() )
            desired_final_vol = parseFloat( $("#hh_final_vol").val() )

            // Get pKa from bufferSystemAttributes using the name of the buffer system
            bufferSystemName = $("select#buffer_system").val()

            if ( bufferSystemName == "(custom)" ) {
                pKa = $("#hh_pka").val();
            } else {
                pKa = bufferSystemAttributes[bufferSystemName][0];
            }

            console.log("pKa: " + pKa );

            // base / acid ratio = 10^(desired_final_ph - pKa)
            ratio_base_to_acid = Math.pow(10, desired_final_ph - pKa)
            console.log("ratio_base_to_acid: " + ratio_base_to_acid );

            // intermediates
            intermediate_molar_acid = desired_final_conc / ( 1 +  ratio_base_to_acid )
            console.log("intermediate_molar_acid: " + intermediate_molar_acid );
            intermediate_molar_base = desired_final_conc - intermediate_molar_acid
            console.log("intermediate_molar_base: " + intermediate_molar_base );

            // final
            final_acid_mass = intermediate_molar_acid * calc_acid * desired_final_vol
            console.log("final_acid_mass: " + final_acid_mass );
            final_base_mass = intermediate_molar_base * calc_base * desired_final_vol
            console.log("final_base_mass: " + final_base_mass );

            // Write out required mass for
            $("#hh_req_acid_mass").val( final_acid_mass.toFixed(2) );
            $("#hh_req_base_mass").val( final_base_mass.toFixed(2) );

            // TODO: write a few test cases

        }

        function checkInputFieldPermissions( ) {
            //////
            // Runs when switching TO custom buffer system
            if ( $('#buffer_system').val() == "(custom)" ) {

                // wipe previous values
                $('#hh_acid_mw').val('');
                $('#hh_base_mw').val('');
                $('#hh_pka').val('');

                // enable user input
                $('#hh_acid_mw').prop('disabled', false);
                $('#hh_base_mw').prop('disabled', false);
                $('#hh_pka').prop('disabled', false);

                // disable the named buffers
                $('#hh_acid').val("  (custom)  ");
                $('#hh_base').val("  (custom)  ");

            } else {
            //////
            // Runs when switching TO our stock buffer systems

                // enable buffer system drop down
                $('#buffer_system').prop('disabled', false);

                // disable user input
                $('#hh_acid_mw').prop('disabled', true);
                $('#hh_base_mw').prop('disabled', true);
                $('#hh_pka').prop('disabled', true);

            };
        }

        function updateBufferSystemAttributes () {
            bufferSystemName = $("select#buffer_system").val()
            console.log(bufferSystemName);

            checkInputFieldPermissions();

            if ( bufferSystemName != "(custom)" ) {
                $("#hh_acid").val(bufferSystemAttributes[bufferSystemName][1]);
                $("#hh_acid_mw").val(bufferSystemAttributes[bufferSystemName][2]);
                $("#hh_acid_mw_units").val(bufferSystemAttributes[bufferSystemName][3]);

                $("#hh_base").val(bufferSystemAttributes[bufferSystemName][4]);
                $("#hh_base_mw").val(bufferSystemAttributes[bufferSystemName][5]);
                $("#hh_base_mw_units").val(bufferSystemAttributes[bufferSystemName][6]);

                $("#hh_pka").val(bufferSystemAttributes[bufferSystemName][0]);
            };

        }


        /////////////////////
        //  Actual page binding 
        /////////////////////

        $(document).ready(function() {

            // On changing the buffer system update the buffer attributes
            $("#buffer_system").on('change', updateBufferSystemAttributes);
            $("#hh_run").on('click', hendersonHasselbalch );

            // If in debug mode show the button to run tests
            if ( DEBUG ) {
                $('#hh_run_tests').show();
                $('#hh_run_tests').on('click', runTestSuite);
            };

        });


    </script>

    <style type="text/css">
        input[type="text"]{
            width:80px;
        }
        .tg  {border-collapse:collapse;border-spacing:0;}
        .tg td, th {
            font-family:Arial, sans-serif;font-size:14px;font-weight:normal;
            padding:10px 5px;
            text-align: center;
            border: 1px solid lightgrey;
            overflow:hidden;word-break:normal;}
        #hh_acid_mw_units_selector, #hh_base_mw_units_selector {display: none;};
        #hh_run_tests {display: none;};
    </style>

<head>

<body>

<table class="tg">
  <tr>


<!-- //////////////////////////////////////
          Buffer System
////////////////////////////////////// -->

    <th class="tg_calc">
        buffer system: <br />
        <select id="buffer_system">
            <option>(custom)</option>
            <option selected="selected">Sodium phosphate</option>
            <option>Tris</option>
            <option>Ammonium acetate 1</option>
            <option>Ammonium acetate 2</option>
        </select>
        <br />
    </th>


<!-- //////////////////////////////////////
          Acid Name 
////////////////////////////////////// -->

    <th class="tg_calc">
        acid:<br />
        <input type="text" id="hh_acid" value="NaH2PO4" disabled="disabled"><br />
    </th>


<!-- //////////////////////////////////////
          Acid Mw
////////////////////////////////////// -->

    <th class="tg_calc">
        acid Mw:<br />
        <input type="text" id="hh_acid_mw" value="119.98" disabled="disabled"> <input type="text" id="hh_acid_mw_units" value="g/mol" disabled="disabled">
    </th>


<!-- //////////////////////////////////////
          Base Name
////////////////////////////////////// -->

    <th class="tg_calc">
        base:<br />
        <input type="text" id="hh_base" value="NA2HPO4" disabled="disabled"><br />
    </th>


<!-- //////////////////////////////////////
          Base Mw Cell
////////////////////////////////////// -->

    <th class="tg_calc">
        base Mw:<br />
        <input type="text" id="hh_base_mw" value="141.96" disabled="disabled"> <input type="text" id="hh_base_mw_units" value="g/mol" disabled="disabled">
    </th>
    
  </tr>

  <tr>
    <td class="tg_calc">Enter your requirements:</td>
    <td class="tg_calc">
        pH: <br />
        <input type="text" id="hh_final_ph">
    </td>
    <td class="tg_calc">
        Concentration: <br />
        <input type="text" id="hh_final_conc"> M
    </td>
    <td class="tg_calc">
        Volume: <br />
        <input type="text" id="hh_final_vol"> L
    </td>
    <td class="tg_calc">
        pKa: <br />
        <input type="text" id="hh_pka" value="6.82" disabled="disabled">
    </td>
  </tr>

</table>

<p> &nbsp; </p>
<button id="hh_run">calculate</button> <br /> <br />
<p> &nbsp; </p>



Results:
<table class="tg" id="results">
  <tr>
    <td class="tg_calc"> You need</td>
    <td class="tg_calc">
        Acid mass:<br/>
        <input type="text" id="hh_req_acid_mass"> g
    </td>
    <td class="tg_calc">
        Base mass:<br/>
        <input type="text" id="hh_req_base_mass"> g
    </td>
    <td class="tg_calc"></td>
    <td class="tg_calc"></td>
  </tr>

</table>

<p> &nbsp; </p>
<button id="hh_run_tests">run tests</button>

</body>

</html>
