<html>
<head>
    <script src="jquery.min.js"></script>
    <script>

        //// Buffer System Attributes:
        // Change these to update the values which are placed in the input boxes
        //  "System Name":          ["acid",          acid Mw,  "base",         base Mw]
        var stockBufferSystems = {
            "Sodium phosphate":     ["NaH2PO4",       119.98,   "Na2HPO4",      141.96],
            "Tris":                 ["Tris-HCl",      157.59,   "Tris-OH",      121.136],
            "Ammonium acetate":     ["Acetic acid",   60.05,    "NH4-acetate",  77.0825],
        }

        // change this to enable running test suite
        var debugOn = true;

        /////////////////////
        //  Establish functions
        /////////////////////

        // enable custom logging
        var log = function() { if (debugOn) { console.log(arguments) } };

        function runTestSuite(){
            //   buffer name         acid Mw,   base Mw,    pH,     conc,   vol,    acid out,   base out,   pKa 
            testSystems = [
                ['Tris',             157.591,   121.136,    7,      1,      0.5,    '74.26',    '3.49',     8.214],
                ['Sodium phosphate', 119.98,    141.96,     7.4,    1,      0.5,    '12.49',    '56.20',    6.82],
                ['(custom)',         60.05,     77.0825,    8.5,    1,      0.1,    '5.10',     '1.16',     9.25],    
            ];

            for (i = 0; i < testSystems.length; i++) {
                // select system
                $("#buffer_system").val( testSystems[i][0] );

                // input test values
                $("#hh_acid_mw").val( testSystems[i][1] );
                $("#hh_base_mw").val( testSystems[i][2] );
                $("#hh_input_ph").val( testSystems[i][3] );
                $("#hh_input_conc").val( testSystems[i][4] );
                $("#hh_input_vol").val( testSystems[i][5] );
                $("#hh_input_pka").val( testSystems[i][8] );

                // fire off calculation
                $('#hh_run').trigger('click');

                // verify outputs
                if ( $('#hh_req_acid_mass').val() == testSystems[i][6] && $('#hh_req_base_mass').val() == testSystems[i][7] ){
                    console.log( "------------ " + testSystems[i][0] + " PASSED!" );
                } else {
                    console.log( "------------ " + testSystems[i][0] + " FAILED!" );
                }
            }

            // clear out test residuals
            $("input[id^='hh_']").val("")
            $("#buffer_system").val("Sodium phosphate");
            updateStockBufferSystems();

        }

        // ensure stockBufferSystems is correctly formatted
        function verifyBufferSystemFormatting( obj ){
            $.each( obj, function(key, value) {
                typeof( key ) == "string" ? "" : alert('stockBufferSystems key: ' + key + ' should be a string');
                typeof( value[0] ) == "string" ? "" : alert('The 1st entry in \"' + key + '\" should be a string');
                typeof( value[1] ) == "number" ? "" : alert('The 2nd entry in \"' + key + '\" should be a number');
                typeof( value[2] ) == "string" ? "" : alert('The 3rd entry in \"' + key + '\" should be a string');
                typeof( value[3] ) == "number" ? "" : alert('The 4th entry in \"' + key + '\" should be a number');
            });
            
            
        }

        function log10(val) {
            return Math.log(val) / Math.LN10;
        }

        function hendersonHasselbalch() {
            calc_acid = parseFloat( $("#hh_acid_mw").val() );
            calc_base = parseFloat( $("#hh_base_mw").val() );
            desired_final_ph = parseFloat( $("#hh_input_ph").val() )
            desired_final_conc = parseFloat( $("#hh_input_conc").val() )
            desired_final_vol = parseFloat( $("#hh_input_vol").val() )

            bufferSystemName = $("select#buffer_system").val()

            pKa = $("#hh_input_pka").val();

            // base / acid ratio = 10^(desired_final_ph - pKa)
            ratio_base_to_acid = Math.pow(10, desired_final_ph - pKa)
            log( "ratio_base_to_acid: " + ratio_base_to_acid );

            // intermediates
            intermediate_molar_acid = desired_final_conc / ( 1 +  ratio_base_to_acid )
            log( "intermediate_molar_acid: " + intermediate_molar_acid );
            intermediate_molar_base = desired_final_conc - intermediate_molar_acid
            log( "intermediate_molar_base: " + intermediate_molar_base );

            // final
            final_acid_mass = intermediate_molar_acid * calc_acid * desired_final_vol
            log( "final_acid_mass: " + final_acid_mass );
            final_base_mass = intermediate_molar_base * calc_base * desired_final_vol
            log( "final_base_mass: " + final_base_mass );

            // Write out required mass for
            $("#hh_req_acid_mass").val( final_acid_mass.toFixed(2) );
            $("#hh_req_base_mass").val( final_base_mass.toFixed(2) );

        }

        function checkInputFieldPermissions() {
            //////
            // Runs when switching TO custom buffer system
            if ( $('#buffer_system').val() == "(custom)" ) {

                // wipe previous values
                $('#hh_acid_mw').val('');
                $('#hh_base_mw').val('');
                $('#hh_input_pka').val('');

                // enable user input
                $('#hh_acid_mw').prop('disabled', false);
                $('#hh_base_mw').prop('disabled', false);
                $('#hh_input_pka').prop('disabled', false);

                // disable the named buffers
                $('#hh_acid').val("  (custom)  ");
                $('#hh_base').val("  (custom)  ");

            } else {
            //////
            // Runs when switching TO our stock buffer systems

                // enable buffer system drop down
                $('#buffer_system').prop('disabled', false);

                // disable user input
                $('#hh_acid_mw').prop('disabled', true);
                $('#hh_base_mw').prop('disabled', true);

            };
        }

        function updateStockBufferSystems () {
            bufferSystemName = $("select#buffer_system").val()
            log(bufferSystemName);

            checkInputFieldPermissions();

            if ( bufferSystemName != "(custom)" ) {
                $("#hh_acid").val(stockBufferSystems[bufferSystemName][0]);
                $("#hh_acid_mw").val(stockBufferSystems[bufferSystemName][1]);

                $("#hh_base").val(stockBufferSystems[bufferSystemName][2]);
                $("#hh_base_mw").val(stockBufferSystems[bufferSystemName][3]);

            };

        }


        /////////////////////
        //  Actual page binding 
        /////////////////////

        $(document).ready(function() {
            // On changing the buffer system update the buffer attributes
            $("#buffer_system").on('change', updateStockBufferSystems);
            $("#hh_run").on('click', hendersonHasselbalch );

            // If in debug mode show the button to run tests
            debugOn && $('#hh_run_tests').show().on('click', runTestSuite);

            verifyBufferSystemFormatting(stockBufferSystems);

            // dynamically populate buffer system dropdown
            $.each(stockBufferSystems, function(key, value) {
                $('#buffer_system').append(
                    $("<option></option>").text(key)
                );
            });

            // set page default to first object in stockBufferSystems 
            $('#buffer_system').val( Object.keys( stockBufferSystems )[0] )


        });

    </script>

    <style type="text/css">
        .tg_calc {padding:10px 15px;}
        input[type="text"]{
            width:80px;
        }
        .tg  {border-collapse:collapse;border-spacing:0;}
        .tg td, th {
            font-family:Arial, sans-serif;font-size:14px;font-weight:normal;
            padding:10px 5px;
            text-align: center;
            border: 1px solid lightgrey;
            overflow: hidden;
            word-break: normal;
        }
        #hh_run_tests { display: none;};
    </style>

<head>

<body>

<table class="tg">
  <tr>


<!-- //////////////////////////////////////
          Buffer System
////////////////////////////////////// -->

    <th class="tg_calc">
        buffer system: <br />
        <select id="buffer_system">
            <option>(custom)</option>
        </select>
        <br />
    </th>


<!-- //////////////////////////////////////
          Acid Name 
////////////////////////////////////// -->

    <th class="tg_calc">
        acid:<br />
        <input type="text" id="hh_acid" value="NaH2PO4" disabled="disabled"><br />
    </th>


<!-- //////////////////////////////////////
          Acid Mw
////////////////////////////////////// -->

    <th class="tg_calc">
        acid Mw:<br />
        <input type="text" id="hh_acid_mw" value="119.98" disabled="disabled">
        g/mol
    </th>


<!-- //////////////////////////////////////
          Base Name
////////////////////////////////////// -->

    <th class="tg_calc">
        base:<br />
        <input type="text" id="hh_base" value="NA2HPO4" disabled="disabled"><br />
    </th>


<!-- //////////////////////////////////////
          Base Mw Cell
////////////////////////////////////// -->

    <th class="tg_calc">
        base Mw:<br />
        <input type="text" id="hh_base_mw" value="141.96" disabled="disabled">
        g/mol
    </th>
    
  </tr>

  <tr>
    <td class="tg_calc">Enter your requirements:</td>
    <td class="tg_calc">
        pH: <br />
        <input type="text" id="hh_input_ph">
    </td>
    <td class="tg_calc">
        Concentration: <br />
        <input type="text" id="hh_input_conc"> M
    </td>
    <td class="tg_calc">
        Volume: <br />
        <input type="text" id="hh_input_vol"> L
    </td>
    <td class="tg_calc">
        pKa: <br />
        <input type="text" id="hh_input_pka">
    </td>
  </tr>

</table>

<p> &nbsp; </p>
<button id="hh_run">calculate</button> <br /> <br />
<p> &nbsp; </p>



Results:
<table class="tg" id="results">
  <tr>
    <td class="tg_calc"> You need</td>
    <td class="tg_calc">
        Acid mass:<br/>
        <input type="text" id="hh_req_acid_mass"> g
    </td>
    <td class="tg_calc">
        Base mass:<br/>
        <input type="text" id="hh_req_base_mass"> g
    </td>
  </tr>

</table>

<p> &nbsp; </p>
<button id="hh_run_tests">run tests</button>

</body>

</html>
